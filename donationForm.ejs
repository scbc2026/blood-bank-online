<!DOCTYPE html>
<html>
<head>
    <title>Donation Entry - SCBC</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; }
        .header { background: #d9534f; color: white; padding: 15px; text-align: center; font-size: 24px; font-weight: bold; }
        .main-container { display: flex; gap: 20px; padding: 20px; max-width: 1200px; margin: auto; }
        .card { background: white; padding: 25px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .left-panel { flex: 2; position: relative; } 
        .right-panel { flex: 1; height: fit-content; }
        
        .row { display: flex; gap: 15px; margin-bottom: 15px; }
        .input-group { flex: 1; }
        label { display: block; font-weight: 600; font-size: 13px; color: #555; margin-bottom: 5px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        
        .btn-save { width: 100%; padding: 15px; background: #28a745; color: white; border: none; font-size: 16px; font-weight: bold; cursor: pointer; border-radius: 5px; margin-top: 10px; }
        .btn-save:hover { background: #218838; }

        /* DISABLED STATE STYLE */
        .form-disabled {
            opacity: 0.6; 
            pointer-events: none; 
            background-color: #f8f9fa;
        }

        /* ALERTS */
        .alert-box { padding: 15px; border-radius: 5px; margin-bottom: 20px; font-weight: bold; font-size: 16px; text-align: center; }
        .alert-danger { background-color: #ffe6e6; color: #d8000c; border: 2px solid #d8000c; }
        .alert-warning { background-color: #fff3cd; color: #856404; border: 2px solid #ffeeba; }
    </style>
</head>
<body>

    <div class="header">ü©∏ Shiva Charitable Blood Centre, Guna</div>

    <div class="main-container">
        
        <div class="card left-panel">
            
            <% if (isBlocked) { %>
                <div class="alert-box alert-danger">
                    üõë STOP: <%= alertMessage %> <br>
                    <small>(Entry Disabled due to Medical History)</small>
                </div>
            <% } else if (isWarning) { %>
                <div class="alert-box alert-warning">
                    ‚ö†Ô∏è WARNING: <%= alertMessage %>
                </div>
            <% } %>

            <h3>üìù Donation Entry Form</h3>
            
            <form action="/save-donation" method="POST">
                
                <fieldset <%= isBlocked ? 'disabled' : '' %> class="<%= isBlocked ? 'form-disabled' : '' %>" style="border:none; padding:0; margin:0;">

                    <input type="hidden" name="mobile" value="<%= donor.mobile %>">

                    <div class="row" style="background: #e9ecef; padding: 10px; border-radius: 5px;">
                        <div class="input-group">
                            <label>üìÖ Donation Date <span style="color:red">*</span></label>
                            <input type="date" name="donationDate" required value="<%= new Date().toISOString().split('T')[0] %>">
                        </div>
                    </div>

                    <div class="row">
                        <div class="input-group">
                            <label>Donor Name <span style="color:red">*</span></label>
                            <input type="text" name="name" value="<%= donor.name %>" required placeholder="Enter Full Name">
                        </div>
                        <div class="input-group">
                            <label>Father's Name <span style="color:red">*</span></label>
                            <input type="text" name="fatherName" value="<%= donor.fatherName %>" required placeholder="Enter Father's Name">
                        </div>
                    </div>

                    <div class="row">
                        <div class="input-group">
                            <label>Mobile</label>
                            <input type="text" value="<%= donor.mobile %>" disabled style="background:#eee;">
                        </div>
                        <div class="input-group">
                            <label>Age <span style="color:red">*</span></label>
                            <input type="number" name="age" value="<%= donor.age %>" required placeholder="Years">
                        </div>
                        <div class="input-group">
                            <label>Gender <span style="color:red">*</span></label>
                            <select name="gender" required>
                                <option value="">Select Gender</option>
                                <option value="Male" <%= donor.gender == 'Male' ? 'selected' : '' %>>Male</option>
                                <option value="Female" <%= donor.gender == 'Female' ? 'selected' : '' %>>Female</option>
                            </select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="input-group">
                            <label>Blood Group <span style="color:red">*</span></label>
                            <select name="bloodGroup" required>
                                <option value="">Select Group</option>
                                <option value="A+" <%= donor.bloodGroup == 'A+' ? 'selected' : '' %>>A+</option>
                                <option value="B+" <%= donor.bloodGroup == 'B+' ? 'selected' : '' %>>B+</option>
                                <option value="O+" <%= donor.bloodGroup == 'O+' ? 'selected' : '' %>>O+</option>
                                <option value="AB+" <%= donor.bloodGroup == 'AB+' ? 'selected' : '' %>>AB+</option>
                                <option value="A-" <%= donor.bloodGroup == 'A-' ? 'selected' : '' %>>A-</option>
                                <option value="B-" <%= donor.bloodGroup == 'B-' ? 'selected' : '' %>>B-</option>
                                <option value="O-" <%= donor.bloodGroup == 'O-' ? 'selected' : '' %>>O-</option>
                                <option value="AB-" <%= donor.bloodGroup == 'AB-' ? 'selected' : '' %>>AB-</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label>Address <span style="color:red">*</span></label>
                            <input type="text" name="address" value="<%= donor.address %>" required placeholder="City / Village">
                        </div>
                    </div>

                    <hr>

                    <div class="row">
                        <div class="input-group">
                            <label>Bag Number <span style="color:red">*</span></label>
                            <input type="text" name="bagNumber" placeholder="Code+YY+Series" required>
                        </div>
                        <div class="input-group">
                            <label>Donation Type <span style="color:red">*</span></label>
                            <select name="donationType" required>
                                <option value="Voluntary">Voluntary</option>
                                <option value="Replacement">Replacement</option>
                                <option value="Camp">Camp</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="input-group">
                             <label>Bag Type <span style="color:red">*</span></label>
                             <select name="bagType" required>
                                 <option value="Single">Single (350ml)</option>
                                 <option value="Double">Double (450ml)</option>
                                 <option value="Triple">Triple</option>
                                 <option value="Quadruple">Quadruple</option>
                             </select>
                        </div>
                    </div>

                    <h4 style="margin-bottom:10px;">üî¨ Lab Results</h4>
                    <div class="row">
                        <div class="input-group"><label>HIV</label><select name="hiv"><option value="Non-Reactive">Non-Reactive</option><option value="Reactive">Reactive</option></select></div>
                        <div class="input-group"><label>HBsAg</label><select name="hbsag"><option value="Non-Reactive">Non-Reactive</option><option value="Reactive">Reactive</option></select></div>
                        <div class="input-group"><label>HCV</label><select name="hcv"><option value="Non-Reactive">Non-Reactive</option><option value="Reactive">Reactive</option></select></div>
                    </div>
                    <div class="row">
                        <div class="input-group"><label>Syphilis</label><select name="syphilis"><option value="Non-Reactive">Non-Reactive</option><option value="Reactive">Reactive</option></select></div>
                        <div class="input-group"><label>Malaria</label><select name="malaria"><option value="Non-Reactive">Non-Reactive</option><option value="Reactive">Positive</option></select></div>
                    </div>

                    <% if (isBlocked) { %>
                        <button type="button" class="btn-save" style="background:#d9534f; cursor:not-allowed;" disabled>‚ùå Entry Restricted</button>
                    <% } else { %>
                        <button type="submit" class="btn-save">‚úÖ Save Donation Entry</button>
                    <% } %>

                </fieldset> </form>
            
            <br>
            <a href="/dashboard" style="display:block; text-align:center; color:#d9534f; text-decoration:none;">&larr; Back to Dashboard</a>
        </div>

        <div class="card right-panel">
            <h3>üìú Previous History</h3>
            <% if (history.length > 0) { %>
                <table style="width:100%; font-size:13px; border-collapse:collapse;">
                    <thead><tr style="background:#eee; text-align:left;"><th>Date</th><th>Result</th></tr></thead>
                    <tbody>
                        <% history.forEach(function(item) { %>
                            <tr style="border-bottom:1px solid #ddd;">
                                <td style="padding:8px;"><%= item.donationDate.toDateString() %></td>
                                <td>
                                    <% if(item.hiv=='Reactive' || item.hbsag=='Reactive' || item.hcv=='Reactive' || item.syphilis=='Reactive') { %> 
                                        <span style="color:red; font-weight:bold;">Reactive</span> 
                                    <% } else if (item.malaria === 'Reactive') { %>
                                        <span style="color:#d39e00; font-weight:bold;">Malaria+</span>
                                    <% } else { %>
                                        <span style="color:green;">Safe</span>
                                    <% } %>
                                </td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>
            <% } else { %>
                <p>No previous records.</p>
            <% } %>
        </div>
    </div>

</body>
</html>
